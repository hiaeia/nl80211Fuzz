
#include "lnetlink.h"
#include "ieee80211.h"

#define u8  unsigned char
#define u16 unsigned short
#define u32 unsigned int
#define u64 unsigned long
#define s8  char
#define s16 short
#define s32 int
#define s64 long
#define IFNAMSIZ 16
#define ETH_ALEN 6

#define NLA_TYPE_MAX (__NLA_TYPE_MAX - 1)

enum {
    NLA_UNSPEC,
    NLA_U8,
    NLA_U16,
    NLA_U32,
    NLA_U64,
    NLA_STRING,
    NLA_FLAG,
    NLA_MSECS,
    NLA_NESTED,
    NLA_NESTED_COMPAT,
    NLA_NUL_STRING,
    NLA_BINARY,
    NLA_S8,
    NLA_S16,
    NLA_S32,
    NLA_S64,
    __NLA_TYPE_MAX,
};

struct nla_policy {
    u16     type;
    u16     len;
};
struct nl80211_sta_flag_update {
    u32 mask;
    u32 set;
} __attribute__((packed));

const u16 nla_attr_minlen[NLA_TYPE_MAX+1] = {
    [NLA_U8]    = sizeof(u8),
    [NLA_U16]   = sizeof(u16),
    [NLA_U32]   = sizeof(u32),
    [NLA_U64]   = sizeof(u64),
    [NLA_MSECS] = sizeof(u64),
    [NLA_NESTED]    = NLA_HDRLEN,
    [NLA_S8]    = sizeof(s8),
    [NLA_S16]   = sizeof(s16),
    [NLA_S32]   = sizeof(s32),
    [NLA_S64]   = sizeof(s64),
};

const struct nla_policy nl80211_policy[NL80211_ATTR_MAX+1] = {
    [NL80211_ATTR_WIPHY] = { .type = NLA_U32 },
    [NL80211_ATTR_WIPHY_NAME] = { .type = NLA_NUL_STRING,
                      .len = 20-1 },
    [NL80211_ATTR_WIPHY_TXQ_PARAMS] = { .type = NLA_NESTED },
    [NL80211_ATTR_WIPHY_FREQ] = { .type = NLA_U32 },
    [NL80211_ATTR_WIPHY_CHANNEL_TYPE] = { .type = NLA_U32 },
    [NL80211_ATTR_CHANNEL_WIDTH] = { .type = NLA_U32 },
    [NL80211_ATTR_CENTER_FREQ1] = { .type = NLA_U32 },
    [NL80211_ATTR_CENTER_FREQ2] = { .type = NLA_U32 },
    [NL80211_ATTR_WIPHY_RETRY_SHORT] = { .type = NLA_U8 },
    [NL80211_ATTR_WIPHY_RETRY_LONG] = { .type = NLA_U8 },
    [NL80211_ATTR_WIPHY_FRAG_THRESHOLD] = { .type = NLA_U32 },
    [NL80211_ATTR_WIPHY_RTS_THRESHOLD] = { .type = NLA_U32 },
    [NL80211_ATTR_WIPHY_COVERAGE_CLASS] = { .type = NLA_U8 },
    [NL80211_ATTR_IFTYPE] = { .type = NLA_U32 },
    [NL80211_ATTR_IFINDEX] = { .type = NLA_U32 },
    [NL80211_ATTR_IFNAME] = { .type = NLA_NUL_STRING, .len = IFNAMSIZ-1 },
    [NL80211_ATTR_MAC] = { .len = ETH_ALEN },
    [NL80211_ATTR_PREV_BSSID] = { .len = ETH_ALEN },
    [NL80211_ATTR_KEY] = { .type = NLA_NESTED, },
    [NL80211_ATTR_KEY_DATA] = { .type = NLA_BINARY,
                    .len = WLAN_MAX_KEY_LEN },
    [NL80211_ATTR_KEY_IDX] = { .type = NLA_U8 },
    [NL80211_ATTR_KEY_CIPHER] = { .type = NLA_U32 },
    [NL80211_ATTR_KEY_DEFAULT] = { .type = NLA_FLAG },
    [NL80211_ATTR_KEY_SEQ] = { .type = NLA_BINARY, .len = 16 },
    [NL80211_ATTR_KEY_TYPE] = { .type = NLA_U32 },
    [NL80211_ATTR_BEACON_INTERVAL] = { .type = NLA_U32 },
    [NL80211_ATTR_DTIM_PERIOD] = { .type = NLA_U32 },
    [NL80211_ATTR_BEACON_HEAD] = { .type = NLA_BINARY,
                       .len = IEEE80211_MAX_DATA_LEN },
    [NL80211_ATTR_BEACON_TAIL] = { .type = NLA_BINARY,
                       .len = IEEE80211_MAX_DATA_LEN },
    [NL80211_ATTR_STA_AID] = { .type = NLA_U16 },
    [NL80211_ATTR_STA_FLAGS] = { .type = NLA_NESTED },
    [NL80211_ATTR_STA_LISTEN_INTERVAL] = { .type = NLA_U16 },
    [NL80211_ATTR_STA_SUPPORTED_RATES] = { .type = NLA_BINARY,
                           .len = NL80211_MAX_SUPP_RATES },
    [NL80211_ATTR_STA_PLINK_ACTION] = { .type = NLA_U8 },
    [NL80211_ATTR_STA_VLAN] = { .type = NLA_U32 },
    [NL80211_ATTR_MNTR_FLAGS] = { /* NLA_NESTED can't be empty */ },
    [NL80211_ATTR_MESH_ID] = { .type = NLA_BINARY,
                   .len = IEEE80211_MAX_MESH_ID_LEN },
    [NL80211_ATTR_MPATH_NEXT_HOP] = { .type = NLA_U32 },
    [NL80211_ATTR_REG_ALPHA2] = { .type = NLA_STRING, .len = 2 },
    [NL80211_ATTR_REG_RULES] = { .type = NLA_NESTED },
    [NL80211_ATTR_BSS_CTS_PROT] = { .type = NLA_U8 },
    [NL80211_ATTR_BSS_SHORT_PREAMBLE] = { .type = NLA_U8 },
    [NL80211_ATTR_BSS_SHORT_SLOT_TIME] = { .type = NLA_U8 },
    [NL80211_ATTR_BSS_BASIC_RATES] = { .type = NLA_BINARY,
                       .len = NL80211_MAX_SUPP_RATES },
    [NL80211_ATTR_BSS_HT_OPMODE] = { .type = NLA_U16 },
    [NL80211_ATTR_MESH_CONFIG] = { .type = NLA_NESTED },
    [NL80211_ATTR_SUPPORT_MESH_AUTH] = { .type = NLA_FLAG },
    [NL80211_ATTR_HT_CAPABILITY] = { .len = NL80211_HT_CAPABILITY_LEN },
    [NL80211_ATTR_MGMT_SUBTYPE] = { .type = NLA_U8 },
    [NL80211_ATTR_IE] = { .type = NLA_BINARY,
                  .len = IEEE80211_MAX_DATA_LEN },
    [NL80211_ATTR_SCAN_FREQUENCIES] = { .type = NLA_NESTED },
    [NL80211_ATTR_SCAN_SSIDS] = { .type = NLA_NESTED },
    [NL80211_ATTR_SSID] = { .type = NLA_BINARY,
                .len = IEEE80211_MAX_SSID_LEN },
    [NL80211_ATTR_AUTH_TYPE] = { .type = NLA_U32 },
    [NL80211_ATTR_REASON_CODE] = { .type = NLA_U16 },
    [NL80211_ATTR_FREQ_FIXED] = { .type = NLA_FLAG },
    [NL80211_ATTR_TIMED_OUT] = { .type = NLA_FLAG },
    [NL80211_ATTR_USE_MFP] = { .type = NLA_U32 },
    [NL80211_ATTR_STA_FLAGS2] = {
        .len = sizeof(struct nl80211_sta_flag_update),
    },
    [NL80211_ATTR_CONTROL_PORT] = { .type = NLA_FLAG },
    [NL80211_ATTR_CONTROL_PORT_ETHERTYPE] = { .type = NLA_U16 },
    [NL80211_ATTR_CONTROL_PORT_NO_ENCRYPT] = { .type = NLA_FLAG },
    [NL80211_ATTR_PRIVACY] = { .type = NLA_FLAG },
    [NL80211_ATTR_CIPHER_SUITE_GROUP] = { .type = NLA_U32 },
    [NL80211_ATTR_WPA_VERSIONS] = { .type = NLA_U32 },
    [NL80211_ATTR_PID] = { .type = NLA_U32 },
    [NL80211_ATTR_4ADDR] = { .type = NLA_U8 },
    [NL80211_ATTR_PMKID] = { .type = NLA_BINARY,
                 .len = WLAN_PMKID_LEN },
    [NL80211_ATTR_DURATION] = { .type = NLA_U32 },
    [NL80211_ATTR_COOKIE] = { .type = NLA_U64 },
    [NL80211_ATTR_TX_RATES] = { .type = NLA_NESTED },
    [NL80211_ATTR_FRAME] = { .type = NLA_BINARY,
                 .len = IEEE80211_MAX_DATA_LEN },
    [NL80211_ATTR_FRAME_MATCH] = { .type = NLA_BINARY, },
    [NL80211_ATTR_PS_STATE] = { .type = NLA_U32 },
    [NL80211_ATTR_CQM] = { .type = NLA_NESTED, },
    [NL80211_ATTR_LOCAL_STATE_CHANGE] = { .type = NLA_FLAG },
    [NL80211_ATTR_AP_ISOLATE] = { .type = NLA_U8 },
    [NL80211_ATTR_WIPHY_TX_POWER_SETTING] = { .type = NLA_U32 },
    [NL80211_ATTR_WIPHY_TX_POWER_LEVEL] = { .type = NLA_U32 },
    [NL80211_ATTR_FRAME_TYPE] = { .type = NLA_U16 },
    [NL80211_ATTR_WIPHY_ANTENNA_TX] = { .type = NLA_U32 },
    [NL80211_ATTR_WIPHY_ANTENNA_RX] = { .type = NLA_U32 },
    [NL80211_ATTR_MCAST_RATE] = { .type = NLA_U32 },
    [NL80211_ATTR_OFFCHANNEL_TX_OK] = { .type = NLA_FLAG },
    [NL80211_ATTR_KEY_DEFAULT_TYPES] = { .type = NLA_NESTED },
    [NL80211_ATTR_WOWLAN_TRIGGERS] = { .type = NLA_NESTED },
    [NL80211_ATTR_STA_PLINK_STATE] = { .type = NLA_U8 },
    [NL80211_ATTR_SCHED_SCAN_INTERVAL] = { .type = NLA_U32 },
    [NL80211_ATTR_REKEY_DATA] = { .type = NLA_NESTED },
    [NL80211_ATTR_SCAN_SUPP_RATES] = { .type = NLA_NESTED },
    [NL80211_ATTR_HIDDEN_SSID] = { .type = NLA_U32 },
    [NL80211_ATTR_IE_PROBE_RESP] = { .type = NLA_BINARY,
                     .len = IEEE80211_MAX_DATA_LEN },
    [NL80211_ATTR_IE_ASSOC_RESP] = { .type = NLA_BINARY,
                     .len = IEEE80211_MAX_DATA_LEN },
    [NL80211_ATTR_ROAM_SUPPORT] = { .type = NLA_FLAG },
    [NL80211_ATTR_SCHED_SCAN_MATCH] = { .type = NLA_NESTED },
    [NL80211_ATTR_TX_NO_CCK_RATE] = { .type = NLA_FLAG },
    [NL80211_ATTR_TDLS_ACTION] = { .type = NLA_U8 },
    [NL80211_ATTR_TDLS_DIALOG_TOKEN] = { .type = NLA_U8 },
    [NL80211_ATTR_TDLS_OPERATION] = { .type = NLA_U8 },
    [NL80211_ATTR_TDLS_SUPPORT] = { .type = NLA_FLAG },
    [NL80211_ATTR_TDLS_EXTERNAL_SETUP] = { .type = NLA_FLAG },
    [NL80211_ATTR_DONT_WAIT_FOR_ACK] = { .type = NLA_FLAG },
    [NL80211_ATTR_PROBE_RESP] = { .type = NLA_BINARY,
                      .len = IEEE80211_MAX_DATA_LEN },
    [NL80211_ATTR_DFS_REGION] = { .type = NLA_U8 },
    [NL80211_ATTR_DISABLE_HT] = { .type = NLA_FLAG },
    [NL80211_ATTR_HT_CAPABILITY_MASK] = {
        .len = NL80211_HT_CAPABILITY_LEN
    },
    [NL80211_ATTR_NOACK_MAP] = { .type = NLA_U16 },
    [NL80211_ATTR_INACTIVITY_TIMEOUT] = { .type = NLA_U16 },
    [NL80211_ATTR_BG_SCAN_PERIOD] = { .type = NLA_U16 },
    [NL80211_ATTR_WDEV] = { .type = NLA_U64 },
    [NL80211_ATTR_USER_REG_HINT_TYPE] = { .type = NLA_U32 },
    [NL80211_ATTR_SAE_DATA] = { .type = NLA_BINARY, },
    [NL80211_ATTR_VHT_CAPABILITY] = { .len = NL80211_VHT_CAPABILITY_LEN },
    [NL80211_ATTR_SCAN_FLAGS] = { .type = NLA_U32 },
    [NL80211_ATTR_P2P_CTWINDOW] = { .type = NLA_U8 },
    [NL80211_ATTR_P2P_OPPPS] = { .type = NLA_U8 },
    [NL80211_ATTR_ACL_POLICY] = {. type = NLA_U32 },
    [NL80211_ATTR_MAC_ADDRS] = { .type = NLA_NESTED },
    [NL80211_ATTR_STA_CAPABILITY] = { .type = NLA_U16 },
    [NL80211_ATTR_STA_EXT_CAPABILITY] = { .type = NLA_BINARY, },
    [NL80211_ATTR_SPLIT_WIPHY_DUMP] = { .type = NLA_FLAG, },
    [NL80211_ATTR_DISABLE_VHT] = { .type = NLA_FLAG },
    [NL80211_ATTR_VHT_CAPABILITY_MASK] = {
        .len = NL80211_VHT_CAPABILITY_LEN,
    },
    [NL80211_ATTR_MDID] = { .type = NLA_U16 },
    [NL80211_ATTR_IE_RIC] = { .type = NLA_BINARY,
                  .len = IEEE80211_MAX_DATA_LEN },
};

